# 残高詳細画面 (BALANCE_DETAIL)

## 画面ID
`BALANCE_DETAIL`

## 画面の目的
- 特定フレンドとの詳細な残高状況を確認
- フレンドとの取引履歴をタイムラインで表示
- 当該フレンドに対するクイックアクション（立替・返済）を実行

## 表示要素

### ヘッダー

**左側**
- 戻るボタン（左矢印アイコン）

**中央**
- 画面タイトル: 「残高詳細」

**右側**
- メニューボタン（3点ドットアイコン）

### フレンド情報＆残高サマリー

**フレンド情報**（中央揃え）
- フレンドアバター（大きく表示）
  - 例: 「佐」
- フレンド名
  - 例: 「佐藤 花子」
- フレンドID
  - 例: 「@sato_hanako」

**残高表示**
- ラベル: 「現在の残高」
- 方向性の表示
  - 貸している場合: 「あなたが貸している」（緑色）
  - 借りている場合: 「あなたが借りている」（赤色）
- 残高金額（大きく表示）
  - 例: 「¥6,000」
  - 状況に応じた色（貸し: 緑、借り: 赤）

### アクションボタン

2つのボタンが横並び：

1. **立替を申請**（プライマリ）
   - ドルマークアイコン
   - ラベル: 「立替を申請」

2. **返済を記録**（セカンダリ）
   - カードアイコン
   - ラベル: 「返済を記録」

### 残高の内訳セクション

**ヘッダー**
- タイトル: 「残高の内訳」

**内訳カード**

1. あなたが立て替えた額
   - ドット（緑色）
   - ラベル: 「あなたが立て替えた額」
   - 金額: 例「¥12,000」（緑色）

2. 相手が立て替えた額
   - ドット（赤色）
   - ラベル: 「相手が立て替えた額」
   - 金額: 例「¥6,000」（赤色）

3. 区切り線

4. 差し引き残高（太字）
   - ラベル: 「差し引き残高」
   - 金額: 例「¥6,000」（状況に応じた色）

### 取引履歴セクション

**ヘッダー**
- タイトル: 「取引履歴」
- フィルタードロップダウン
  - オプション: すべて / 立替のみ / 返済のみ
  - デフォルト: すべて

**タイムライン表示**

月別グループ構成：
- 月表示: 例「2025年12月」

各取引アイテムの構成：
- タイムラインドット（左側）
- タイプと日付（ヘッダー行）
  - 取引タイプ
    - 「立替（あなた→相手）」
    - 「立替（相手→あなた）」
    - 「返済（あなた→相手）」
    - 「返済（相手→あなた）」
  - 日付: 例「12/19」
- メモ
  - 例: 「ランチ代」
- 金額
  - 貸し方向: 例「+¥3,000」（緑色）
  - 借り方向: 例「-¥1,200」（赤色）
- ステータスバッジ
  - 承認待ち: オレンジ
  - 確定済み: グレー

**取引タイプ別のスタイル**
- 立替（あなた→相手）: 緑系の背景
- 立替（相手→あなた）: 赤系の背景
- 返済（相手→あなた）: 緑系の背景
- 返済（あなた→相手）: 赤系の背景

表示例：
```
2025年12月
├─ 立替（あなた→相手） 12/19
│  ランチ代
│  +¥3,000
│  [承認待ち]
│
├─ 返済（相手→あなた） 12/15
│  映画代の返済
│  +¥1,800
│  [確定済み]
│
└─ 立替（相手→あなた） 12/10
   カフェ代
   -¥1,200
   [確定済み]

2025年11月
├─ 立替（あなた→相手） 11/28
...
```

## ユーザーアクション

| アクション | トリガー | 遷移先/処理 | 使用API |
|---|---|---|---|
| 戻る | 戻るボタンクリック | 前画面へ戻る | - |
| メニュー表示 | メニューボタンクリック | メニューモーダル表示 | - |
| 立替を申請 | 立替ボタンクリック | 立替申請モーダル表示（相手固定） | - |
| 返済を記録 | 返済ボタンクリック | 返済記録モーダル表示（相手固定） | - |
| フィルター変更 | ドロップダウン選択 | 履歴リストのフィルタリング | - |
| 取引詳細確認 | 取引アイテムクリック | 取引詳細モーダル表示 | - |

## モーダル一覧

### modal-menu（メニュー）

**表示項目**
- 相殺を提案
- フレンド情報を編集
- フレンドを削除（デンジャー）

### modal-advance（立替申請作成）

**表示項目**
- タイトル: 「立替を申請」
- 閉じるボタン（×）

**フォーム項目**

1. 相手（固定表示）
   - アバター
   - フレンド名: 例「佐藤 花子」

2. 金額
   - 数値入力（¥プレフィックス付き）
   - プレースホルダー: 「0」
   - 最小値: 1

3. 日付
   - date型input
   - デフォルト: 当日
   - ヒント: 「未来の日付は選択できません」

4. メモ（任意）
   - テキスト入力
   - プレースホルダー: 「例：ランチ代」

**ボタン**
- キャンセルボタン（セカンダリ）
- 申請するボタン（プライマリ）

### modal-repayment（返済記録作成）

**表示項目**
- タイトル: 「返済を記録」
- 閉じるボタン（×）

**フォーム項目**

1. 相手（固定表示）
   - アバター
   - フレンド名: 例「佐藤 花子」
   - 現在の残高: 例「現在 ¥6,000 貸し」

2. 金額
   - 数値入力（¥プレフィックス付き）
   - プレースホルダー: 「0」
   - 最小値: 1
   - ヒント: 「相手からあなたへの返済として記録されます」

3. 日付
   - date型input
   - デフォルト: 当日

4. メモ（任意）
   - テキスト入力
   - プレースホルダー: 「例：ランチ代の返済」

**ボタン**
- キャンセルボタン（セカンダリ）
- 記録するボタン（プライマリ）

### modal-offset（相殺提案作成）

**表示項目**
- タイトル: 「相殺を提案」
- 閉じるボタン（×）

**内容**

1. 相手（固定表示）
   - アバター
   - フレンド名: 例「佐藤 花子」

2. 相殺情報カード
   - ラベル: 「相殺可能額」
   - 金額: 例「¥6,000」（大きく表示）
   - 注記: 「全額相殺で清算完了」

3. 相殺後の残高プレビュー
   - タイトル: 「相殺後の残高」
   - 変化の表示:
     - 現在
       - ラベル: 「現在」
       - 値: 例「¥6,000 貸し」（緑色）
     - 矢印アイコン
     - 相殺後
       - ラベル: 「相殺後」
       - 値: 「¥0 清算」（太字、緑色）

**ボタン**
- キャンセルボタン（セカンダリ）
- 提案するボタン（プライマリ）

### modal-transaction-detail（取引詳細）

**表示項目**
- タイトル: 「取引詳細」
- 閉じるボタン（×）

**取引サマリー**（中央揃え）
- 取引バッジ
  - 例: [立替]（カラーバッジ）
- 金額（大きく表示）
  - 例: 「+¥3,000」（色付き）
- 方向性
  - 例: 「あなた → 佐藤 花子さん」

**詳細情報カード**
- 日付: 例「2025/12/19」
- メモ: 例「ランチ代」
- ステータス: [承認待ち] バッジ
- 申請日時: 例「2025/12/19 14:30」

**ボタン**（承認待ちの場合のみ表示）
- 閉じるボタン（セカンダリ）
- この申請を取り消すボタン（デンジャー、ゴースト）

## 使用API

### 初期表示時

**特定フレンドとの残高詳細取得**
```
GET /api/v1/balances/:userId
```
レスポンス例:
```json
{
  "user": {"id": "user_002", "name": "佐藤花子"},
  "net": {"lent": 6000, "borrowed": 0}
}
```

**取引履歴取得**
```
GET /api/v1/histories?userId={userId}&include=official
```
レスポンス例:
```json
{
  "advances": [
    {
      "id": "adv_001",
      "counterparty": {"id": "user_002", "name": "佐藤花子"},
      "direction": "OUTGOING",
      "amount": 3000,
      "occurredDate": "2025-10-19",
      "type": "NORMAL",
      "note": "ランチ代",
      "createdAt": "2025-10-19T12:00:00Z"
    }
  ],
  "repayments": [
    {
      "id": "rep_001",
      "counterparty": {"id": "user_002", "name": "佐藤花子"},
      "direction": "INCOMING",
      "amount": 1000,
      "occurredDate": "2025-10-21",
      "note": "ランチ代返済",
      "createdAt": "2025-10-21T12:00:00Z"
    }
  ]
}
```

### 立替申請作成時

```
POST /api/v1/advance-requests
```
リクエストボディ:
```json
{
  "payerId": "user_001",
  "receiverId": "user_002",
  "amount": 3000,
  "occurredDate": "2025-10-19",
  "note": "ランチ代"
}
```

### 返済記録作成時

```
POST /api/v1/repayments
```
リクエストボディ:
```json
{
  "payerId": "user_002",
  "receiverId": "user_001",
  "amount": 2000,
  "occurredDate": "2025-10-21",
  "note": "ランチ返済"
}
```

### 相殺提案作成時

```
POST /api/v1/offset-requests
```
リクエストボディ:
```json
{
  "counterpartyUserId": "user_002"
}
```

### 申請取消時

```
POST /api/v1/advance-requests/:id/cancel
```

## 画面遷移

### 遷移元
- ホーム画面: フレンドアイテムクリック時
- フレンド画面: フレンドアイテムクリック時

### 遷移先
- なし（モーダルのみ）

## 実装時の注意事項

1. **履歴の表示**
   - 月別グループは新しい月が上
   - 各月内は新しい取引が上
   - 初期表示は直近3ヶ月程度に制限
   - スクロールで過去の履歴を無限読み込み

2. **フィルタリング**
   - フィルター変更は即座に反映
   - フィルター状態はセッションに保存

3. **リアルタイム更新**
   - 相手が承認した場合、ステータスが自動更新されるように

4. **エラーハンドリング**
   - フレンドが見つからない場合は404画面へ
   - API呼び出し失敗時は適切なエラーメッセージ

5. **パフォーマンス**
   - 履歴は仮想スクロールで実装
   - 画像の遅延読み込み

6. **内訳の計算**
   - 内訳は残高APIのレスポンスから計算
   - クライアント側で集計しない
