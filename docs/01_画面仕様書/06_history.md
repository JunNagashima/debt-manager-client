# 履歴画面 (HISTORY)

## 画面ID
`HISTORY`

## 画面の目的
- すべての取引履歴を時系列で表示
- 月別のサマリー情報を提供
- フィルター機能で必要な履歴を絞り込む

## 表示要素

### ヘッダー

**中央**
- 画面タイトル: 「履歴」

**右側**
- 検索ボタン（虫眼鏡アイコン）

### 月間サマリーセクション

**月ナビゲーション**
- 前月ボタン（左矢印）
- 現在の月表示: 例「2025年12月」
- 次月ボタン（右矢印、未来月は無効化）

**サマリー統計**（3つの項目が横並び）

1. 取引件数
   - ラベル: 「取引件数」
   - 値: 例「12件」

2. 受取合計
   - ラベル: 「受取合計」
   - 値: 例「+¥15,800」（緑色）

3. 支払合計
   - ラベル: 「支払合計」
   - 値: 例「-¥8,200」（赤色）

### フィルター

**フィルターチップ**（横スクロール可能）
- すべて（デフォルト選択）
- 立替
- 返済
- 相殺

**詳細フィルターボタン**
- 漏斗アイコン

### 履歴リスト

**日別グループ構成**

**日付ヘッダー**
- 日付: 例「20」（大きく）
- 曜日: 例「金」（小さく）

**取引アイテムリスト**

各アイテムの構成：

**左側**
- アイコン（円形、取引タイプと方向）
  - 立替（あなた→相手）: 上向き矢印、緑背景
  - 立替（相手→あなた）: 下向き矢印、赤背景
  - 返済（相手→あなた）: 下向き矢印、緑背景
  - 返済（あなた→相手）: 上向き矢印、赤背景

**中央**
- 取引タイプ: 「立替」「返済」「相殺」
- 相手名（方向表示付き）
  - 例: 「→ 鈴木 一郎」（あなた→相手）
  - 例: 「← 佐藤 花子」（相手→あなた）
- メモ: 例「タクシー代」

**右側**
- 金額
  - 受取方向: 例「+¥2,000」（緑色）
  - 支払方向: 例「-¥1,200」（赤色）

**表示例**
```
20 金
├─ [↑] 立替 → 鈴木 一郎          +¥2,000
│      タクシー代
│
└─ [↓] 返済 ← 佐藤 花子          +¥3,000
       ランチ代の返済

19 木
├─ [↓] 立替 ← 田中 美咲          -¥1,500
...
```

## ユーザーアクション

| アクション | トリガー | 遷移先/処理 | 使用API |
|---|---|---|---|
| 検索 | 検索ボタンクリック | 検索モーダル表示 | - |
| 月変更（前月） | 前月ボタンクリック | 表示月変更、履歴再取得 | GET /api/v1/histories |
| 月変更（次月） | 次月ボタンクリック | 表示月変更、履歴再取得 | GET /api/v1/histories |
| フィルター適用 | チップクリック | リストのフィルタリング | - |
| 詳細フィルター | フィルターボタンクリック | 詳細フィルターモーダル表示 | - |
| 取引詳細確認（立替） | 立替アイテムクリック | 立替詳細モーダル表示 | - |
| 取引詳細確認（返済） | 返済アイテムクリック | 返済詳細モーダル表示 | - |
| 取引詳細確認（相殺） | 相殺アイテムクリック | 相殺詳細モーダル表示 | - |

## モーダル一覧

### modal-search（検索）

**表示項目**
- タイトル: 「履歴を検索」
- 閉じるボタン（×）

**検索フォーム**

1. キーワード
   - テキスト入力
   - プレースホルダー: 「メモから検索」

2. 期間
   - 開始日（date型input）
   - 終了日（date型input）

3. フレンド
   - セレクトボックス（複数選択可）
   - プレースホルダー: 「フレンドを選択」

4. 金額範囲
   - 最小金額（数値入力）
   - 最大金額（数値入力）

**ボタン**
- クリアボタン（セカンダリ）
- 検索ボタン（プライマリ）

### modal-filter（詳細フィルター）

**表示項目**
- タイトル: 「詳細フィルター」
- 閉じるボタン（×）

**フィルター項目**

1. 取引タイプ（チェックボックス）
   - すべて
   - 立替
   - 返済
   - 相殺

2. 方向（ラジオボタン）
   - すべて
   - 受取のみ
   - 支払のみ

3. フレンド（セレクトボックス、複数選択可）
   - プレースホルダー: 「フレンドを選択」

4. 金額範囲
   - 最小金額
   - 最大金額

**ボタン**
- リセットボタン（セカンダリ）
- 適用ボタン（プライマリ）

### modal-history-detail-advance（立替詳細）

**表示項目**
- タイトル: 「立替の詳細」
- 閉じるボタン（×）

**立替サマリー**
- 立替バッジ: [立替]
- 金額: 例「+¥3,000」（方向に応じた色）
- 方向性: 例「あなた → 佐藤 花子さん」

**詳細情報カード**
- 立替日: 例「2025/12/19」
- メモ: 例「ランチ代」
- タイプ: NORMAL または ADJUSTMENT
- 作成日時: 例「2025/12/19 12:00」

**ボタン**
- 閉じるボタン（セカンダリ、フル幅）

### modal-history-detail-repayment（返済詳細）

**表示項目**
- タイトル: 「返済の詳細」
- 閉じるボタン（×）

**返済サマリー**
- 返済バッジ: [返済]
- 金額: 例「+¥2,000」（方向に応じた色）
- 方向性: 例「佐藤 花子さん → あなた」

**詳細情報カード**
- 返済日: 例「2025/12/20」
- メモ: 例「ランチ代の返済」
- 作成日時: 例「2025/12/20 12:00」

**ボタン**
- 閉じるボタン（セカンダリ、フル幅）

### modal-history-detail-offset（相殺詳細）

**表示項目**
- タイトル: 「相殺の詳細」
- 閉じるボタン（×）

**相殺サマリー**
- 相殺バッジ: [相殺]
- 相殺額: 例「¥2,500」
- 相手: 例「鈴木 一郎さん」

**詳細情報カード**
- 相殺日: 例「2025/12/20」
- 実行日時: 例「2025/12/20 12:00」
- 注記: 「相殺により双方向の返済が記録されました」

**ボタン**
- 閉じるボタン（セカンダリ、フル幅）

## 使用API

### 初期表示時

**履歴取得（月別）**
```
GET /api/v1/histories?include=official&from={from}&to={to}
```
パラメータ例:
- from: "2025-12-01"
- to: "2025-12-31"

レスポンス例:
```json
{
  "advances": [
    {
      "id": "adv_001",
      "counterparty": {"id": "user_002", "name": "佐藤花子"},
      "direction": "OUTGOING",
      "amount": 3000,
      "occurredDate": "2025-12-19",
      "type": "NORMAL",
      "note": "ランチ代",
      "createdAt": "2025-12-19T12:00:00Z"
    }
  ],
  "repayments": [
    {
      "id": "rep_001",
      "counterparty": {"id": "user_002", "name": "佐藤花子"},
      "direction": "INCOMING",
      "amount": 2000,
      "occurredDate": "2025-12-20",
      "note": "ランチ代の返済",
      "createdAt": "2025-12-20T12:00:00Z",
      "source": "MANUAL"
    }
  ]
}
```

### 検索時

**フィルター付き履歴取得**
```
GET /api/v1/histories?include=official&from={from}&to={to}&userId={userId}
```

### 立替詳細取得時

```
GET /api/v1/advances/:id
```

### 返済詳細取得時

```
GET /api/v1/repayments/:id
```

## 画面遷移

### 遷移元
- ホーム画面
- ボトムナビゲーション

### 遷移先
- なし（モーダルのみ）

## 実装時の注意事項

1. **日付グループの生成**
   - 取引を occurredDate でグループ化
   - 同日の取引は createdAt で降順ソート

2. **サマリーの計算**
   - 選択中の月のみ集計
   - 相殺は返済2件として計上

3. **フィルタリング**
   - フィルター適用は即座に反映
   - フィルター状態はセッションに保存
   - URLパラメータでフィルター共有可能にする（将来）

4. **検索機能**
   - メモのキーワード検索
   - 部分一致で検索
   - 検索結果は日付グループ表示維持

5. **空の状態**
   - 該当する履歴がない場合は空状態メッセージ
   - 「この月はまだ履歴がありません」など

6. **パフォーマンス**
   - 仮想スクロールで大量の履歴に対応
   - 月別データのキャッシング
   - スクロール位置の保持

7. **相殺の表示**
   - 相殺は返済2件として記録されている
   - source="OFFSET" でバッジ表示
   - 詳細モーダルで相殺であることを明示

8. **リアルタイム更新**
   - 新規取引追加時は自動でリストに反映
   - 取引の削除・編集も反映

9. **アクセシビリティ**
   - 日付グループはランドマークとして認識可能に
   - アイコンは色だけでなく形でも識別可能
