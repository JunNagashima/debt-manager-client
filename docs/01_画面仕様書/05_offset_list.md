# 相殺申請一覧画面 (OFFSET_LIST)

## 画面ID
`OFFSET_LIST`

## 画面の目的
- 相殺可能なフレンドを表示
- 相殺申請の送受信を管理
- 相殺の仕組みを理解しやすくする

## 表示要素

### ヘッダー

**中央**
- 画面タイトル: 「相殺申請」

**右側**
- ヘルプボタン（?アイコン）

### 相殺説明バナー

**構成**
- アイコン: ⚖️（大きく表示）
- タイトル: 「相殺とは？」
- 説明文: 「お互いの貸し借りを差し引きして、残高をまとめて精算できます」

### 相殺できるフレンドセクション

**ヘッダー**
- タイトル: 「相殺できるフレンド」

**フレンドカード**

各カードの構成：
- アバター
- フレンド名: 例「鈴木 一郎」
- 相殺可能額: 例「相殺可能: ¥2,500」
- 「提案する」ボタン

**ヒント**
- 「※ お互いに貸し借りがあるフレンドのみ表示されます」

### タブ切り替え

2つのタブ：

1. **受け取った提案**
   - 件数バッジ付き（承認待ちの件数）
   - 例: 「受け取った提案 [1]」

2. **送った提案**
   - バッジなし

### 受け取った提案タブコンテンツ

#### 承認待ちセクション

**ヘッダー**
- ステータスドット（オレンジ）
- タイトル: 「承認待ち」
- 件数表示: 例「1件」

**相殺カードリスト**

各カードの構成：

**ヘッダー行**
- ユーザー情報（左側）
  - アバター
  - ユーザー名: 例「鈴木 一郎」
  - 申請日: 例「2025/12/20 申請」
- ステータスバッジ（右側）: 「承認待ち」（オレンジ）

**ボディ**
- 相殺額
  - ラベル: 「相殺額」
  - 金額: 例「¥2,500」（大きく表示）
- 相殺プレビュー
  - 現在
    - ラベル: 「現在」
    - 値: 例「¥2,500 借り」（赤色）
  - 矢印アイコン
  - 相殺後
    - ラベル: 「相殺後」
    - 値: 「¥0 清算」（緑色）

#### 承認済みセクション

**ヘッダー**
- ステータスドット（緑）
- タイトル: 「承認済み」
- 件数表示: 例「2件」

**相殺カードリスト**
- 基本構成は承認待ちと同じ
- ステータスバッジ: 「承認済み」（緑）
- 承認日表示: 例「12/20 承認」

#### 却下セクション

**ヘッダー**
- ステータスドット（赤）
- タイトル: 「却下」
- 件数表示: 例「0件」

**相殺カードリスト**
- 基本構成は承認待ちと同じ
- ステータスバッジ: 「却下」（赤）
- 却下日表示: 例「12/20 却下」

### 送った提案タブコンテンツ

**構成は受け取った提案と同様**

違い：
- 承認待ちカードには「取り消す」ボタンがある

## ユーザーアクション

| アクション | トリガー | 遷移先/処理 | 使用API |
|---|---|---|---|
| ヘルプ表示 | ?ボタンクリック | 相殺説明モーダル表示 | - |
| 相殺提案 | 提案するボタンクリック | 相殺提案作成モーダル表示 | - |
| タブ切り替え | タブクリック | タブコンテンツの切り替え | - |
| 承認待ち提案確認 | カードクリック | 承認モーダル表示 | - |
| 承認済み提案確認 | カードクリック | 承認済み詳細モーダル表示 | - |
| 却下提案確認 | カードクリック | 却下詳細モーダル表示 | - |
| 送った提案詳細 | カードクリック（送った提案） | 送信中詳細モーダル表示 | - |
| 送った提案取消 | 取り消すボタンクリック | 提案取消 | POST /api/v1/offset-requests/:id/cancel |

## モーダル一覧

### modal-help（相殺の説明）

**表示項目**
- タイトル: 「相殺について」
- 閉じるボタン（×）

**内容**
- セクション1: 「相殺とは」
  - 説明文
- セクション2: 「具体例」
  - イラストまたは図解
- セクション3: 「注意事項」
  - 箇条書きリスト

**ボタン**
- 閉じるボタン（プライマリ）

### modal-offset-create（相殺提案作成）

**表示項目**
- タイトル: 「相殺を提案」
- 閉じるボタン（×）

**内容**

1. 相手（固定表示）
   - アバター
   - フレンド名: 例「鈴木 一郎」

2. 相殺情報カード
   - ラベル: 「相殺可能額」
   - 金額: 例「¥2,500」（大きく表示）
   - 注記: 「全額相殺で清算完了」

3. 相殺後の残高プレビュー
   - タイトル: 「相殺後の残高」
   - 変化の表示:
     - 現在: 例「¥2,500 借り」（赤色）
     - 矢印アイコン
     - 相殺後: 「¥0 清算」（緑色、太字）

**ボタン**
- キャンセルボタン（セカンダリ）
- 提案するボタン（プライマリ）

### modal-approve-offset（相殺申請承認）

**表示項目**
- タイトル: 「相殺申請の確認」
- 閉じるボタン（×）

**申請内容カード**
- 申請者: 例「鈴木 一郎さん」
- 相殺額: 例「¥2,500」（大きく表示）

**相殺後残高プレビュー**（中央揃え）
- ラベル: 「相殺後の残高」
- 変化の表示:
  - 現在: 例「¥2,500 借り」（赤色）
  - 矢印アイコン
  - 相殺後: 「¥0 清算」（緑色、太字）

**ボタン**
- 却下ボタン（デンジャー）
- 承認するボタン（プライマリ）

### modal-detail-approved（承認済み詳細）

**表示項目**
- タイトル: 「相殺申請の詳細」
- 閉じるボタン（×）

**相殺サマリー**
- 相殺バッジ: [相殺] [承認済み]
- 相殺額: 例「¥2,500」

**詳細情報カード**
- 申請日: 例「2025/12/20」
- 承認日: 例「2025/12/20」
- 相手: 例「鈴木 一郎さん」

**ボタン**
- 閉じるボタン（セカンダリ、フル幅）

### modal-detail-rejected（却下詳細）

**表示項目**
- タイトル: 「相殺申請の詳細」
- 閉じるボタン（×）

**相殺サマリー**
- 相殺バッジ: [相殺] [却下]
- 相殺額: 例「¥2,500」

**詳細情報カード**
- 申請日: 例「2025/12/20」
- 却下日: 例「2025/12/21」
- 相手: 例「鈴木 一郎さん」

**ボタン**
- 閉じるボタン（セカンダリ、フル幅）

### modal-detail-sent-pending（送信中詳細）

**表示項目**
- タイトル: 「相殺申請の詳細」
- 閉じるボタン（×）

**相殺サマリー**
- 相殺バッジ: [相殺] [承認待ち]
- 相殺額: 例「¥2,500」
- 相手: 例「鈴木 一郎さん」

**詳細情報カード**
- 申請日: 例「2025/12/20」
- 相殺プレビュー（現在 → 相殺後）

**承認待ち通知**
- 時計アイコン
- メッセージ: 「相手の承認をお待ちください」

**ボタン**（縦並び）
- 閉じるボタン（セカンダリ）
- この提案を取り消すボタン（デンジャー、ゴースト）

## 使用API

### 初期表示時

**残高一覧取得（相殺可能判定用）**
```
GET /api/v1/balances
```

**相殺申請一覧取得**
```
GET /api/v1/offset-requests
```
レスポンス例:
```json
[
  {
    "id": "offreq_001",
    "requesterId": "user_001",
    "counterpartyUserId": "user_002",
    "status": "PENDING",
    "createdAt": "2025-10-22T10:00:00Z",
    "updatedAt": "2025-10-22T10:00:00Z"
  }
]
```

### 相殺提案作成時

```
POST /api/v1/offset-requests
```
リクエストボディ:
```json
{
  "counterpartyUserId": "user_002"
}
```
レスポンス: 201 Created

### 相殺申請承認時

```
POST /api/v1/offset-requests/:id/approve
```
レスポンス: 200 OK

### 相殺申請却下時

```
POST /api/v1/offset-requests/:id/reject
```
リクエストボディ（任意）:
```json
{
  "reason": "今回は相殺しないでおきたい"
}
```
レスポンス: 200 OK

### 相殺申請取消時

```
POST /api/v1/offset-requests/:id/cancel
```
レスポンス: 200 OK

## 画面遷移

### 遷移元
- ホーム画面
- ボトムナビゲーション

### 遷移先
- なし（モーダルのみ）

## 実装時の注意事項

1. **相殺可能判定**
   - お互いに貸し借りがある（lent > 0 かつ borrowed > 0）
   - min(lent, borrowed) > 0

2. **相殺可能額の計算**
   - offsetAmount = min(netAtoB, netBtoA)
   - サーバー側で計算推奨

3. **相殺の実行**
   - 承認時点で再度相殺可能額を確認
   - 残高が変動している可能性あり

4. **空の状態**
   - 相殺できるフレンドがいない場合
   - 「相殺できるフレンドはいません」メッセージ

5. **エラーハンドリング**
   - 相殺可能額なしエラー（409 NO_OFFSET_AVAILABLE）
   - 適切なエラーメッセージ表示

6. **リアルタイム更新**
   - 承認/却下/取消後は一覧を自動更新
   - 残高変動により相殺可能フレンドが変わる可能性

7. **アクセシビリティ**
   - 相殺プレビューは視覚だけでなくテキストでも理解可能に
   - アイコンにalt属性

8. **パフォーマンス**
   - 相殺可能フレンドの判定はサーバー側で実施
   - クライアント側で再計算しない
