# 返済記録一覧画面 (REPAYMENT_LIST)

## 画面ID
`REPAYMENT_LIST`

## 画面の目的
- 返済記録の送受信を管理
- 月別の返済サマリーを表示
- 返済の詳細確認と編集・取消申請

## 表示要素

### ヘッダー

**中央**
- 画面タイトル: 「返済記録」

**右側**
- 新規作成ボタン（+アイコン）

### サマリーカード

2つの項目が横並び：

1. **今月受け取った**
   - アイコン: 下向き矢印（緑色）
   - ラベル: 「今月受け取った」
   - 金額: 例「¥8,500」（緑色）

2. **今月支払った**
   - アイコン: 上向き矢印（赤色）
   - ラベル: 「今月支払った」
   - 金額: 例「¥3,200」（赤色）

### タブ切り替え

2つのタブ：

1. **受け取った返済**
2. **支払った返済**

### 月別フィルター

**構成**
- 前月ボタン（左矢印）
- 現在の月表示: 例「2025年12月」
- 次月ボタン（右矢印、未来月は無効化）

### 返済リスト

**返済カード**

各カードの構成：

**メイン行**
- ユーザー情報（左側）
  - アバター
  - ユーザー名: 例「佐藤 花子」
  - 日付: 例「2025/12/20」
- 金額（右側）
  - 方向表示: 「受取」または「支払」（小さく）
  - 金額: 例「¥3,000」
  - 受取: 緑色、支払: 赤色

**詳細行**
- メモ: 例「ランチ代の返済」
- 残高状況: 例「残高: ¥6,000 貸し」

**表示例（受け取った返済タブ）**
```
┌─────────────────────────────┐
│ [佐] 佐藤 花子    受取 ¥3,000│
│     2025/12/20                │
│ ランチ代の返済                 │
│ 残高: ¥6,000 貸し             │
└─────────────────────────────┘
```

## ユーザーアクション

| アクション | トリガー | 遷移先/処理 | 使用API |
|---|---|---|---|
| 新規返済記録 | +ボタンクリック | 返済記録作成モーダル表示 | - |
| タブ切り替え | タブクリック | タブコンテンツの切り替え | - |
| 月変更（前月） | 前月ボタンクリック | 表示月変更、リスト再取得 | GET /api/v1/histories |
| 月変更（次月） | 次月ボタンクリック | 表示月変更、リスト再取得 | GET /api/v1/histories |
| 返済詳細確認 | カードクリック | 返済詳細モーダル表示 | - |

## モーダル一覧

### modal-repayment-create（返済記録作成）

**表示項目**
- タイトル: 「返済を記録」
- 閉じるボタン（×）

**フォーム項目**

1. 誰に返済した？
   - セレクトボックス
   - フレンド一覧から選択（残高情報付き）
   - 例: 「佐藤 花子（¥6,000 貸し）」
   - プレースホルダー: 「フレンドを選択」

2. 金額
   - 数値入力（¥プレフィックス付き）
   - プレースホルダー: 「0」
   - 最小値: 1

3. 日付
   - date型input
   - デフォルト: 当日

4. メモ（任意）
   - テキスト入力
   - プレースホルダー: 「例：ランチ代の返済」

**ボタン**
- キャンセルボタン（セカンダリ）
- 記録するボタン（プライマリ）

### modal-repayment-detail（返済詳細）

**表示項目**
- タイトル: 「返済の詳細」
- 閉じるボタン（×）

**返済サマリー**
- 返済バッジ: [返済]
- 金額: 例「¥3,000」（方向に応じた色）
- 方向性: 例「佐藤 花子さん → あなた」

**詳細情報カード**
- 返済日: 例「2025/12/20」
- メモ: 例「ランチ代の返済」
- 作成日時: 例「2025/12/20 12:00」
- 更新日時: 例「2025/12/20 12:00」（編集された場合のみ）

**現在の残高**
- 残高表示: 例「¥6,000 貸し」

**ボタン**
- 閉じるボタン（セカンダリ）
- 編集するボタン（セカンダリ）（payerが本人の場合のみ）
- 取消を申請するボタン（デンジャー、ゴースト）（receiverが本人の場合のみ）

### modal-repayment-edit（返済編集）

**表示項目**
- タイトル: 「返済を編集」
- 閉じるボタン（×）

**フォーム項目**

1. 相手（固定表示、編集不可）
   - アバター
   - ユーザー名

2. 金額
   - 数値入力（¥プレフィックス付き）
   - 現在値が初期表示
   - 最小値: 1

3. 日付
   - date型input
   - 現在値が初期表示

4. メモ（任意）
   - テキスト入力
   - 現在値が初期表示

**ボタン**
- キャンセルボタン（セカンダリ）
- 保存するボタン（プライマリ）

### modal-cancel-request（返済取消申請作成）

**表示項目**
- タイトル: 「返済の取消を申請」
- 閉じるボタン（×）

**説明**
- 「この返済に異議がある場合、取消を申請できます」
- 「相手が承認すると、返済記録が取り消されます」

**返済情報カード**
- 相手: 例「佐藤 花子さん」
- 金額: 例「¥3,000」
- 日付: 例「2025/12/20」
- メモ: 例「ランチ代の返済」

**フォーム項目**
- 理由
  - テキストエリア（必須）
  - プレースホルダー: 「例：受け取っていません」
  - 最大文字数: 200文字

**ボタン**
- キャンセルボタン（セカンダリ）
- 取消を申請するボタン（デンジャー）

## 使用API

### 初期表示時

**返済履歴取得（月別）**
```
GET /api/v1/histories?include=official&from={from}&to={to}
```
パラメータ例:
- from: "2025-12-01"
- to: "2025-12-31"

レスポンス例:
```json
{
  "repayments": [
    {
      "id": "rep_001",
      "counterparty": {"id": "user_002", "name": "佐藤花子"},
      "direction": "INCOMING",
      "amount": 3000,
      "occurredDate": "2025-12-20",
      "note": "ランチ代の返済",
      "createdAt": "2025-12-20T12:00:00Z",
      "source": "MANUAL"
    }
  ]
}
```

### 返済記録作成時

```
POST /api/v1/repayments
```
リクエストボディ:
```json
{
  "payerId": "user_002",
  "receiverId": "user_001",
  "amount": 3000,
  "occurredDate": "2025-12-20",
  "note": "ランチ代の返済"
}
```
レスポンス: 201 Created

### 返済詳細取得時

```
GET /api/v1/repayments/:id
```
レスポンス例:
```json
{
  "id": "rep_001",
  "payer": {"id": "user_002", "name": "佐藤花子"},
  "receiver": {"id": "user_001", "name": "山田太郎"},
  "amount": 3000,
  "occurredDate": "2025-12-20",
  "note": "ランチ代の返済",
  "createdAt": "2025-12-20T12:00:00Z",
  "updatedAt": "2025-12-20T12:00:00Z"
}
```

### 返済編集時

```
PUT /api/v1/repayments/:id
```
リクエストボディ:
```json
{
  "amount": 3500,
  "occurredDate": "2025-12-20",
  "note": "ランチ＋コーヒー代の返済"
}
```
レスポンス: 200 OK

### 返済取消申請作成時

```
POST /api/v1/repayment-cancel-requests
```
リクエストボディ:
```json
{
  "repaymentId": "rep_001",
  "reason": "受け取っていません"
}
```
レスポンス: 201 Created

## 画面遷移

### 遷移元
- ホーム画面
- ボトムナビゲーション

### 遷移先
- なし（モーダルのみ）

## 実装時の注意事項

1. **月別サマリーの計算**
   - サマリーは選択中の月のみ集計
   - APIレスポンスから集計（サーバー側で計算済みの場合はそのまま使用）

2. **月の切り替え**
   - 未来月への移動は無効化
   - 当月に戻るボタンも検討

3. **返済の編集権限**
   - 編集できるのは payer（支払った側）のみ
   - 編集後は相手に通知（将来実装）

4. **取消申請の権限**
   - 取消申請できるのは receiver（受け取る側）のみ
   - 「受け取っていない」という主張

5. **空の状態**
   - 該当する返済がない場合は空状態メッセージ表示
   - 「この月はまだ返済がありません」など

6. **エラーハンドリング**
   - 編集・取消申請失敗時は適切なエラーメッセージ
   - 権限エラーは明確に説明

7. **パフォーマンス**
   - 月別データのキャッシング
   - スクロール位置の保持（月切り替え後）

8. **相殺の扱い**
   - 相殺による返済（source="OFFSET"）は特別なバッジを表示
   - 編集・取消は不可

9. **リアルタイム更新**
   - 編集・取消申請後は一覧を自動更新
   - 相手の操作（取消承認など）も検知
